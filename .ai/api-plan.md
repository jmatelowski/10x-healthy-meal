# REST API Plan

## 1. Resources

| Resource           | DB Table              | Description                                                                      |
| ------------------ | --------------------- | -------------------------------------------------------------------------------- |
| User               | auth.users            | Represents an application user managed by Supabase Auth.                         |
| Recipe             | recipes               | A cooking recipe either entered manually or generated by AI.                     |
| UserDietPreference | user_diet_preferences | Many-to-many join that stores each dietary preference selected by a user.        |
| Generation         | generations           | Stores the result (and metadata) of an AI adaptation request for a recipe.       |
| GenerationErrorLog | generation_error_logs | Internal table capturing details of failed AI generations. (Read-only for users) |

## 2. Endpoints

### 2.1 Authentication

Supabase Auth is used under the hood, but we expose two thin wrapper endpoints that enrich the default response with domain-specific fields (dietary preferences & optional role).

| Method | Path           | Description                                                                |
| ------ | -------------- | -------------------------------------------------------------------------- |
| POST   | `/auth/login`  | Sign in with email/password and return session + user profile information. |
| POST   | `/auth/signup` | Register a new account and immediately return the same payload as login.   |

Both endpoints proxy to the corresponding Supabase Auth calls and then perform an additional query on `user_diet_preferences` (and future `roles`) before forming the response.

#### 2.1.1 `POST /auth/login`

```jsonc
// Request body
{
  "email": "user@example.com",
  "password": "hunter2"
}

// Response 200
{
  "id": "uuid",
  "email": "user@example.com",
  "preferences": ["vegan"],        // Empty array if no prefs yet
}
```

• Returns 401 on invalid credentials.

Implementation notes:

1. Call `supabase.auth.signInWithPassword({ email, password })`.
2. On success, read `session.access_token`, `session.user.id`, `session.expires_in`.
3. Fetch preferences: `SELECT diet_pref FROM user_diet_preferences WHERE user_id = :uid`.
4. Future-proof role: read `raw_user_meta_data.role` or dedicated column if introduced later.
5. Return combined payload.

#### 2.1.2 `POST /auth/signup`

Identical response shape; internally calls `supabase.auth.signUp()` followed by the same enrichment steps.

For all other authenticated requests the client sends the `access_token` in `Authorization: Bearer <jwt>` header.

### 2.2 Users

| Method | Path        | Description                                                                  |
| ------ | ----------- | ---------------------------------------------------------------------------- |
| GET    | `/users/me` | Return the authenticated user profile incl. selected dietary preferences.    |
| DELETE | `/users/me` | Permanently delete the user account **and** cascade-delete all related data. |

#### 2.2.1 `GET /users/me`

```jsonc
// Response 200
{
  "id": "uuid",
  "email": "user@example.com",
  "preferences": ["vegetarian", "gluten_free"],
  "created_at": "2025-10-13T12:00:00Z",
}
```

#### 2.2.2 `DELETE /users/me`

• Returns 204 No Content on success.

### 2.3 Dietary Preferences

| Method | Path                    | Description                                      |
| ------ | ----------------------- | ------------------------------------------------ |
| PUT    | `/users/me/preferences` | Replace the entire array of dietary preferences. |

```jsonc
// Request body
{
  "preferences": ["vegan", "nut_allergy"], // ≤ 6 values, each must belong to diet_pref_enum
}

// Response 204 No Content
```

### 2.4 Recipes

| Method | Path            | Description                              |
| ------ | --------------- | ---------------------------------------- |
| GET    | `/recipes`      | List current user recipes (paginated).   |
| POST   | `/recipes`      | Create a new recipe (source = "manual"). |
| GET    | `/recipes/{id}` | Get a single recipe.                     |
| PUT    | `/recipes/{id}` | Update a recipe.                         |
| DELETE | `/recipes/{id}` | Permanently delete a recipe.             |

#### 2.4.1 Query Params (`GET /recipes`)

| Param       | Type    | Default           | Notes                                                  |
| ----------- | ------- | ----------------- | ------------------------------------------------------ |
| `page`      | integer | 1                 | 1-based page index                                     |
| `page_size` | integer | 20                | max = 100                                              |
| `sort`      | string  | `updated_at desc` | Field and direction (`title asc`, `created_at desc` …) |

Response example:

```jsonc
{
  "data": [
    {
      "id": "uuid",
      "title": "Quinoa Salad",
      "content": "...",
      "source": "manual",
      "created_at": "2025-10-13T12:00:00Z",
      "updated_at": "2025-10-13T12:00:00Z",
    },
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 57,
  },
}
```

#### 2.4.2 `POST /recipes`

Create recipe manually (source = 'manual') added by user

```jsonc
// Request body
{
  "title": "Quinoa Salad",          // ≤ 50 chars
  "content": "..."                  // ≤ 10 000 chars
}

// Response 200
{
  "id": "recipe-uuid",
  "status": "accepted",
  "recipe": {
    "title": "...",
    "content": "..."
  }
}
```

#### 2.4.3 Validation Rules

• `title` ≤ 50 chars, non-empty
• `content` ≤ 10 000 chars, non-empty

### 2.5 AI Generations

| Method | Path                       | Description                                                                                           |
| ------ | -------------------------- | ----------------------------------------------------------------------------------------------------- |
| POST   | `/generations`             | Submit a draft recipe (title + content) for AI adaptation and receive an immediate `recipe_proposal`. |
| GET    | `/generations/{id}`        | Poll generation status & (eventual) AI proposal.                                                      |
| POST   | `/generations/{id}/accept` | Accept AI result and save as recipe (source = "ai").                                                  |
| POST   | `/generations/{id}/reject` | Reject and mark generation as `rejected`.                                                             |

Server stores hashes/lengths of submitted draft in `generations` (status `NULL`) and triggers async worker.

#### 2.5.1 `POST /generations`

Draft payload validation is identical to recipe limits.

```jsonc
// Request body
{
  "title": "Quinoa Salad",          // ≤ 50 chars
  "content": "..."                  // ≤ 10 000 chars
}

// Response 202 Accepted
{
  "id": "generation-uuid",
  "status": "pending",
  "recipe_proposal": {
    "title": "...",
    "content": "..."
  }
}
```

#### 2.5.2 `GET /generations/{id}`

Returns 200 with payload:

```jsonc
{
  "id": "uuid",
  "status": "accepted" | "rejected" | "failed",
  "model": "gpt-4o-mini",
  "duration": 5321,
  "recipe_proposal": {
    "title": "...", // Present only once ready & not yet accepted
    "content": "..."
  },
  "accepted_recipe_id": "uuid | null",
  "created_at": "ISO8601",
  "updated_at": "ISO8601"
}
```

#### 2.5.3 `POST /generations/{id}/accept`

```jsonc
// Response 200
{
  "recipe_id": "uuid",
  "message": "AI recipe saved",
}
```

Atomically performs: insert into `recipes` (source = 'ai') & update generation.status = 'accepted'.

#### 2.5.4 `POST /generations/{id}/reject`

Sets `status = 'rejected'`. Response 204.

### 2.6 (Internal) Error Logs

| Method | Path                       | Description                            |
| ------ | -------------------------- | -------------------------------------- |
| GET    | `/admin/generation-errors` | Admin-only list of failed generations. |

## 3. Authentication & Authorization

1. **Authentication**: Supabase JWT in `Authorization` header.
2. **Row-Level Security**: All tables have RLS enabled; policies allow access only when `user_id = auth.uid()`. The API server uses the client’s JWT for every DB call, inheriting these rules automatically.
3. **Admin routes** (e.g. error logs) require a service role key checked via middleware.

## 4. Validation & Business Logic

| Resource                     | Rule                                                                | Origin                      |
| ---------------------------- | ------------------------------------------------------------------- | --------------------------- |
| Recipe.title                 | ≤ 50 chars                                                          | DB `VARCHAR(50)` + PRD §3.3 |
| Recipe.content               | ≤ 10 000 chars                                                      | DB CHECK + PRD §3.3         |
| Recipe.source                | ∈ {"manual","ai"}                                                   | DB CHECK                    |
| Generation.status            | Nullable during processing; ∈ {accepted,rejected,failed} afterwards | Enum                        |
| UserDietPreference.diet_pref | Must belong to `diet_pref_enum`                                     | Enum                        |

Additional business logic:

1. Accepting a generation performs a single-transaction RPC (`accept_generation`) to insert recipe **and** update generation row (§.ai/db-plan §144-145).
2. Deleting a user cascades deletes to all child rows via `ON DELETE CASCADE`.

## 5. Error Handling (common across endpoints)

| Status                    | When                                                                           |
| ------------------------- | ------------------------------------------------------------------------------ |
| 400 Bad Request           | Payload validation fails (e.g. title too long)                                 |
| 401 Unauthorized          | Missing/invalid Supabase JWT                                                   |
| 403 Forbidden             | Authenticated but accessing another user’s row (will surface as 404 by design) |
| 404 Not Found             | Resource does not exist or not owned by user                                   |
| 409 Conflict              | Duplicate dietary preference                                                   |
| 422 Unprocessable Entity  | Business rule violated (e.g. accepting already accepted generation)            |
| 500 Internal Server Error | Unhandled server error                                                         |

## 6. Pagination, Filtering & Sorting

• Default pagination via `page` & `page_size`.  
• `sort` param supports `<field> <asc|desc>`.  
• Future filtering (e.g. by dietary tag) can be added as query params.

## 7. Rate Limiting & Security Measures

| Measure            | Value                      | Notes                                                          |
| ------------------ | -------------------------- | -------------------------------------------------------------- |
| Global rate limit  | 100 req/min per user       | Enforced via middleware (e.g. `supabase-functions-ratelimit`). |
| Payload size       | 50 KB                      | Prevent overly large request bodies.                           |
| CORS               | Allow frontend origin only | Block unknown origins.                                         |
| TLS                | HTTPS only                 | Enforced at the load balancer.                                 |
| Generation timeout | 30 s for `/generations`    | If processing exceeds 30 s, API returns 504 Gateway Timeout.   |

## 8. Open Questions / Assumptions

1. The API server is deployed as Astro serverless endpoints under `/src/pages/api/*`.
2. AI generation is triggered via background job; the 202 response allows the frontend to poll.
3. Admin routes are hidden from regular docs and protected by service role key.
