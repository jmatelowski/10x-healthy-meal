name: Pull Request CI

on:
  pull_request:
    branches: [master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

  unit-test:
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  e2e-test:
    runs-on: ubuntu-latest
    environment: integration
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: npm run build

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          E2E_USERNAME_ID: ${{ secrets.E2E_USERNAME_ID }}
          PUBLIC_SITE_URL: ${{ secrets.PUBLIC_SITE_URL }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 5

      - name: Upload E2E coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./playwright-report/coverage/lcov.info
          flags: e2e
          name: codecov-umbrella
          fail_ci_if_error: false

  status-comment:
    runs-on: ubuntu-latest
    needs: [lint, unit-test, e2e-test]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment PR with status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const jobResults = jobs.jobs.map(job => ({
              name: job.name,
              conclusion: job.conclusion,
              html_url: job.html_url
            }));

            const allPassed = jobResults.every(job => job.conclusion === 'success');
            const hasFailures = jobResults.some(job => job.conclusion === 'failure');

            let comment = '## CI Status Report\n\n';

            if (allPassed) {
              comment += 'âœ… **All checks passed!**\n\n';
            } else {
              comment += 'âŒ **Some checks failed**\n\n';
            }

            comment += '### Job Results:\n';
            jobResults.forEach(job => {
              const status = job.conclusion === 'success' ? 'âœ…' :
                           job.conclusion === 'failure' ? 'âŒ' :
                           job.conclusion === 'cancelled' ? 'ðŸš«' : 'â³';
              comment += `${status} [${job.name}](${job.html_url}) - ${job.conclusion || 'in_progress'}\n`;
            });

            comment += '\n---\n*This comment was automatically generated by the CI pipeline.*';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('CI Status Report') && comment.user.type === 'Bot'
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
